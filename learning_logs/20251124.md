# AWS free tier(무료 플랜 가입)

# 사용 개념

1. EC2

- 원격으로 접속해서 사용할 수 있는 컴퓨터를 빌려주는 서비스(즉, 내부에 OS가 있고, 거기서 springboot 프로젝트를 실행시키면 원격 접속이 된다는 의미).

2. Route 53

- 도메인 주소를 발급하고 관리하는 서비스(사실 무료로 찾으면 많다.)

3. ELB(Elastic Load Balancing)

- 웹 사이트로 보내는 요청을 연결된 서버로 적절히 나누는 서비스.
- 우리가 구현하는 서비스가 요청을 나눌 정도로 인기가 있는 것은 아니라 HTTPS 성정을 위해 사용

4. RDS

- 관계형 데이터베이스를 빌려주는 서비스. EC2 내에 DB를 넣어서 바로 배포를 해도 되지만 이경우 EC2가 멈췄을 때 다른 DB도 문제가 생기기 때문에 서버를 분산해둔다. RDS에서는 DB관련 제공하는 부가 서비스가 많아 분리해두는 편이다.

5. S3

- 파일을 안전하고 효율적으로 저장할 수 있는 `스토리지를 빌려주는` 서비스. 일상 생황에서 아이 클라우드나 구글 드라이브에 사진 및 문서 / 영상을 올리는 것처럼 파일 자체를 저장할 수 있는 공간이 필요한데, S3를 활용하면 해당 파일을 `객체 단위` 로 쉽게 저장하고 내려받을 수 있다.

6. CloudFront

- 파일이나 영상 등의 컨텐츠를 빠르게 전송하도록 돕는 서비스
- 우리는 Frontend의 정적 웹페이지를 배포하는 용도로 사용.

# EC2로 백엔드 서버 배포하기

1. 배포(Deployment)란 무엇인가
![alt text](image.png)

- 다른 사용자들이 인터넷을 통해서 사용할 웹서비스를 사용할 수 있도록 만드는 것을 의미함.
- 자신의 컴퓨터로 개발할 때는 localhost라는 주소로 테스트도 하고 개발도 했는데, 이는 다른 컴퓨터에서는 접근이 불가능한 주소이다.
  배포 과정을 수행하면 IP(ex.1234.16.2.1)나 도메인 주소(ex.www.naver.com)과 같이 고유한 방식으로 주소를 부여 받아, 다른 컴퓨터에서 이 주소로 접속할 수 있게끔 하는 것을 `배포` 라고 한다.
- 어떤 서비스를 완성했다면, 그 다음 단계로 해야하는 것이 배포에 해당한다.

## EC2

- Elastic Compute Cloud의 축약어로 보통 ECC라 생각하기 쉽지만 AWS는 이니셜이 겹치면 숫자로 퉁쳐버리는 방식으로 네이밍을 한다.
- 컴퓨터를 빌려서 원격으로 접속해 사용하는 서비스.
- 컴퓨터 하나다.

### EC2의 학습이유

- 백엔드 서버를 배포하기 위해서는 컴퓨터가 필요하다.(그래서 서버용 컴퓨터를 24/7 켜두는 경우도 있다.) 내가 가진 컴퓨터에서 서버를 배포해 다른 사용자들이 인터넷을 통해 접근할 수 있게 하는 것이 가능한데, 그러면 내 컴퓨터가 인터넷에 퍼져있는 것이기 때문에 보안적으로 불안하다.

- 그래서 AWS의 EC2라는 컴퓨터를 빌려서 보안적으로도 안전하고, 여러 부가 기능(로깅, 오토스케일링, 로드밸런싱)을 이용하는 것이 보편적이다.

- 현업에서도 서버 배포시 EC2 많이 쓴다.

## 리전(Region)

- 인프라를 지리적으로 나누어 배포한 각각의 데이터 센터.
- EC2는 컴퓨터를 빌려서 원격으로 접속할 수 있게끔 하는데, 부산에 살면서 미국 버지니아 동부에 있는 컴퓨터를 빌려 회원가입할 때마다 미 동부까지 찍고 응답이 온다고 생각하면 된다.

- 이상을 이유로 애플리케이션의 주된 사용자들의 위치와 지리적으로 가까운 리전을 선택하는 것이 유용하다.

- default 값이 미 버지니아 북부로 잡혀있어서 EC2 없다고 다시 만들면 요금이 나온다. 서울로 맞춰둘 것.

- EC2는 리전마다 `따로 관리` 되고 있다.

## EC2 기본 설정

- AWS
  설정 : region을 서울로 잡아두기
  검색창에 ec2 검색 -> 콘솔 홈 내에서 EC2 의 대시보드로 이동
  리소스의 보안 그룹 (기본적으로 1이 생성된다.)
  인스턴스 시작 ->
  - 이름 및 태그: instagram-server
  - 애플리케이션 및 OS 이미지(Amazon Machine Image): Ubuntu
    - OS를 선택하는 단계인데, Windows 나 MacOs는 용량도 많이 차지하고 성능도 많이 잡아먹기 때문에 돈이 너무 많이 든다. 우리가 하나 하나 커스텀할 수 있는 가벼운 OS인 Ubuntu를 이용해 배포하는 편이다.
  - 프리티어
  - 인스턴스 유형
    - t3.micro 선택할 건데, 유형의 의미는 컴퓨터 사양에 해당한다 생각하자
    - micro `<` small ... 순으로 이루어지는데, 사양이 좋을 수록 많은 수의 요청을 처리할 수 있고, 무거운 서버나 프로그램을 운영할 수 있다.
    - t2.micro에서 2000 명 정도의 서비스를 운영해도 별 문제가 없었기 때문에, 굳이 돈내고 유형을 올릴 필요는 없다.
  - 키페어(key pair) 생성 : EC2 컴퓨터에 접근할 때, 사용하는 비밀번호
    - 키 페어 이름은 어떤 EC2에 접근하기 위한 키 페어였는지 알아볼 수 있도록 지정하는 게 좋다.
      - 키페어 이름: `instagram-server-key-pair`
    - 키페어를 생성하면 파일이 하나 다운받아 지는데, 보통은 잃어버리면 안된다. 우리는 계속 지웠다각 깔았다가 할거니까 큰 문제는 없다.
    - 우리 실습에서는 키 페어말고 다른 편한 방식을 사용할 예정.
  - 네트워크 설정
    - 편집 -> vpc, 보안그룹

## EC2 보안 그룹(Security Group) 설정

- 네트워크 설정 -> 보안 그룹 이름 부분에 집중하자.
- Security Group이란

  - 이하의 이미지를 참조하여, EC2 인스턴스가 집이라고 생각한다면 보안 그룹은 집 바깥쪽에 있는 `방화벽(firewall)` 역할이라고 생각할 수 있다. 집에 접근할 때, 방화벽 앞에서 접근해도 되는 요청인지 검사하는 것으로 생각해볼 수 있다.
  ![alt text](image.png)

  - 인터넷에서 일부 사용자가 EC2 인스턴스에 접근(access) 하려고 할 때, 보안 그룹을 만들고 보안 그룹에 `규칙`을 지정한다. 이 규칙에는 _인바운드 트래픽(즉, 외부에서 EC2 인스턴스로 보내는 트래픽)_ 에서 어떤 트래픽만 허용할지 설정할 수 있고, _아웃바운드 트래픽(즉, Ec2 인스턴스에서 외부로 나가는 트래픽)_ 에서 어떤 트래픽만 허용할 지 설정 가능.

  - 보안 그룹 설정 시에 허용할 IP 범위와 포트(port)를 설정 가능.

  * 보안그룹 설정

    - 외부에서 EC2로 접근할 포트는 default인 22번 포트와 80번 포트라고 가정하자.(backend 배포할 때, 8080번이었던 것과 비슷) 80번 포트에서 백엔드 서버를 띄울 예정이다.

    보안 그룹 이름 : `instagram-server-security-group`
    유형: HTTP
    -> HTTP 위치무관 설정
    -> 설정 다 했으면 보안 그룹 추가

    - IP vs. Port

      - IP: 네트워크 상에서 _특정 컴퓨터를 가리키는 주소_
      - Port: 한 컴퓨터 내에서 _실행되고 있는 특정 프로그램의 주소_

      - 그러면 특정 서버와 통신하기 위해서는 ip주소 및 port 번호를 다 알아야할 것 같은데, 우리는 _주소_ 를 이용하여 웹 서비스를 이용한다.
        이는 -> domain 개념과 연결된다.

      - 그러면 ip는 domain과 연결한다고 가정했을 때, port 번호는 모르는데, 어떻게 정상적으로 통신이 가능한가?
      - 주소창에 도메인을 입력하고 엔터치면 브라우저에서 기본적으로 80번 포트로 보내도록 설정돼있다.
      - 그래서 만약에 80번 포트로 보내는 것이 싫다면
        `http://www.naver.com:3000` 과 같은 식으로 지정하는 것도 가능하다.

      - 잘 알려진 포트(Well-known Port)란

        - 0~65,535 번까지 포트 번호 사용가능
        - 그 중에서 0~1023 번까자의 포트는 주요 통신을 위한 규약에 따라 이미 정해져있다.
        - 규약을 통해 역할이 정해져있는 포트번호를 `잘 알려진 포트` 라고 한다.

        - 예시

          - 22(SSH, Secure Shell Protocol): 원격 접속을 위한 포트
            - EC2 인스턴스에 연결할 때, 22번 포트 사용
          - 80(HTTP) : HTTP로 통신할 때 사용.
          - 443(HTTPS): HTTPS로 통신할 때 사용.

          * 규약이 꼭 지켜져야하는 것은 아니다. 80번 포트에 3000이나 8080을 써도 무방하다.

# EC2 스토리지 설정

- EC2가 하나의 컴퓨터다 보니 여러 파일을 저장할 저장 공간이 필요하다. 해당 공간을 EBS(Elastic Block Strage)라고 부른다.
  그냥 EC2 내의 하드디스크라고 생각해도 무방하다. EBS보다 더 포괄적인 용어로 Strage, Volume이라는 표현을 쓰기도 한다.

* 스토리지 구성
  - 30GIB까지 공짜라서 이거 설정
  - gp3 루트 볼륨

## 탄력적 IP 연결하기 (Elastic IP)

- 탄력적 IP의 필요성: EC2 인스턴스를 생성하면 IP를 할당받는다. 이건 임시적이다. EC2를 잠시 중단했다 다시 실행하면 IP가 바뀐다.
  그래서 중지시켰다가 다시 실행해도 바뀌지않는 고정 IP를 할당 받아야하는데, 이를 `탄력적 IP` 라고 한다.

* EC2 콘솔 내부에서 좌측의 사이드 바를 밑으로 내렸을 때, `네트워크 및 보안` 탭 내에 `탄력적 IP`가 있다.
  - `탄력적 IP할당` 버튼을 눌러서 할당 받으면, `기존 인스턴스와 연결`하는 과정이 필수로 요구된다.
  - 할당된 IP 주소를 클릭한 다음, `탄력적 IP연결` 버튼 클릭, 우리 기준으로는 instagram-server 인스턴스와 연결해준다.
  - 그러면 instagram-server의 ip 주소가 아니라 탄력적 ip를 통해 접근하는 것이 가능해진다.

## SpringBoot 프로젝트를 EC2에 배포하기

1. EC2가 컴퓨터라면 컴퓨터에 새 프로젝트를 설치할 필요가 있다. 그러면 새 컴푸터에 JDK를 설치해야한다.

```
sudo apt update &&
```

EC2의 CLI에서 붙여넣기 하고싶다면 : shift + ins

```
sudo apt install openjdk-17-jdk -y
```

jdk 설치가 끝났다면 설치가 완료됐는지 확인

```
java -version
```

3. springbott 예시 프로젝트를 EC2에 clone하기

```
git clone https://github.com/maybeags/aws_practice.git
```

4. 설치됐는지 확인하기 위한 명령어 : ls
5. 내부 폴더로 들어가기 위한 명령어

```
cd aws_practice
cd ec2-spring-boot-sample
```

6. EC2 내부에서 server 실행

```
./gradlew clean build
```

기존 빌드된 파일을 삭제하고 새로 build
8, 6, 7 번 명령어를 실행시키고, Build Successful이 되면 ls 명령어를 입력했을 때, build라고 하는 폴더가 새로 생성된다.

- 기존:
  build.gradle gradle gradlew gradlew.bat settings.gradle src
- build 후(6, 7 명령어 후 ls) :
  build build.gradle gradle gradlew gradlew.bat settings.gradle src

9. build 된 파일을 실행시키기 위해 폴더 이동

```
cd build/libs
```

10. jar 파일 생성

```
sudo java -jar ec2-spring-boot-sample-0.0.1-SNAPSHOT.jar
```

화이트라벨 뜨면 백엔드 배포 성공

## EC2 종료하기

1. EC2 대시보드 들어가서 instagram-server 클릭 -> 우상단에 `인스턴스 상태` -> `인스턴스 종료(삭제)` 클릭

2. 그러면 우리는 빌린 컴퓨터는 반납했다. 근데 하나가 남았다. -> 탄력적 IP

탄력적 IP 주소 릴리스
